require_relative '../lib/pdfium'
require 'pathname'
require 'tempfile'
require 'os'

pdfs=Pathname.glob(Pathname.new(__FILE__).dirname.join("pdfs","*.pdf") )
def comma(num)
  num.to_s.chars.to_a.reverse.each_slice(3).map(&:join).join(",").reverse
end

0.upto(10) do | pass |
  pdfs.each do | file |
    next if file.to_s.match /invalid/
    doc = PDFium::Document.new( file )
    0.upto(doc.page_count-1) do | pg_num |
      page = PDFium::Page.new(doc, pg_num)
      size = rand(500)+100
      tf = Tempfile.new(["pdf-page-test",".gif"])
      page.render(tf.path, size, size*1.4) or die "failed to render pg #{pg_num} of #{file}"
    end
    doc=nil
    GC.start(full_mark: true, immediate_sweep: true)
    puts "%3i %-60s  %s" % [ pass, file.to_s.gsub("./test/pdfs/",''), comma(OS.rss_bytes) ]
  end
end
